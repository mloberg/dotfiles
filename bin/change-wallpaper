#!/usr/bin/env bash
set -e

CONFIG="$HOME/.wallpaper"

if [ "$1" == "init" ]; then
    read -p "Unsplash API key: " -r UNSPLASH_API_KEY
    read -p "Unsplash collection: [1053828] " -r UNSPLASH_COLLECTION
    cat > "$CONFIG" <<EOL
UNSPLASH_API_KEY=${UNSPLASH_API_KEY}
UNSPLASH_COLLECTION=${UNSPLASH_COLLECTION:-1053828}
EOL
fi

# shellcheck source=/dev/null
source "$CONFIG"

[ -z "$UNSPLASH_API_KEY" ] && exit
[ -z "$WALLPAPER_CACHE" ] && WALLPAPER_CACHE="$HOME/Pictures/wallpaper"

url="https://api.unsplash.com/photos/random?collections=${UNSPLASH_COLLECTION:-1053828}"
res=$(curl -s -H "Authorization: Client-ID ${UNSPLASH_API_KEY}" "$url")

id=$(echo "$res" | jq --raw-output ".id")
img="$(echo "$res" | jq --raw-output ".urls.raw")?q=85&w=1920&fm=jpg"
path="${WALLPAPER_CACHE}/${id}.jpg"

mkdir -p "$WALLPAPER_CACHE"
[ -f "$path" ] || curl -s "$img" -o "$path"

sqlite3 ~/Library/Application\ Support/Dock/desktoppicture.db "update data set value = '${path}'" && killall Dock
